# –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è Issues #4 —Ç–∞ #5

## Issue #4: –ú–µ—Ö–∞–Ω—ñ–∑–º –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å

### –ó–º—ñ–Ω–∏:
- ‚úÖ –î–æ–¥–∞–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤ `create_and_send_packet_to()` —É Rust core
- ‚úÖ –î–æ–¥–∞–Ω–æ –ª–æ–≥—É–≤–∞–Ω–Ω—è –≤ `handle_incoming_packet_internal()` –¥–ª—è –≤—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –ø—Ä–∏–π–æ–º—É
- ‚úÖ –í—Å—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ç–µ–ø–µ—Ä –º–∞—é—Ç—å —Ç—Ä–∞—Å—É–≤–∞–Ω–Ω—è –≤—ñ–¥ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –¥–æ –ø—Ä–∏–π–æ–º—É

### –Ø–∫ —Ç–µ—Å—Ç—É–≤–∞—Ç–∏:
1. **–ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–≤–æ—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤:**
   - –ü—Ä–∏—Å—Ç—Ä—ñ–π A: –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ Ya OK
   - –ü—Ä–∏—Å—Ç—Ä—ñ–π B: –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ Ya OK

2. **–î–æ–¥–∞—Ç–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∏:**
   - –ù–∞ –ø—Ä–∏—Å—Ç—Ä–æ—ó A: —Å—Ç–≤–æ—Ä–∏—Ç–∏ QR –∫–æ–¥ (Family ‚Üí —ñ–∫–æ–Ω–∫–∞ QR)
   - –ù–∞ –ø—Ä–∏—Å—Ç—Ä–æ—ó B: —Å–∫–∞–Ω—É–≤–∞—Ç–∏ QR (Family ‚Üí —ñ–∫–æ–Ω–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞)
   - –í–≤–µ–¥—ñ—Ç—å —ñ–º'—è —Ç–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å

3. **–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –¥–æ–¥–∞–≤–∞–Ω–Ω—è (Issue #5):**
   - –ù–∞ –ø—Ä–∏—Å—Ç—Ä–æ—ó A: –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —â–æ –∫–æ–Ω—Ç–∞–∫—Ç –∑ –ø—Ä–∏—Å—Ç—Ä–æ—é B –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑'—è–≤–∏–≤—Å—è –≤ —Å–ø–∏—Å–∫—É
   - –¶–µ –ø—Ä–∞—Ü—é—î –∑–∞–≤–¥—è–∫–∏ `contact_add_request`, —â–æ –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è —á–µ—Ä–µ–∑ `sendTextTo()`

4. **–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:**
   - –ù–∞ –ø—Ä–∏—Å—Ç—Ä–æ—ó A: Main ‚Üí –≤–∏–±—Ä–∞—Ç–∏ —Å—Ç–∞—Ç—É—Å ‚Üí –Ω–∞—Ç–∏—Å–Ω—É—Ç–∏ "–ù–∞–¥—ñ—Å–ª–∞—Ç–∏"
   - –í–∏–±—Ä–∞—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π –∫–æ–Ω—Ç–∞–∫—Ç –∑ –¥—ñ–∞–ª–æ–≥—É
   - –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ "–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –æ–±—Ä–∞–Ω–∏–º"

5. **–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ª–æ–≥–∏ –¥–æ—Å—Ç–∞–≤–∫–∏:**
   ```powershell
   adb logcat | Select-String "üì§ create_and_send|üì• handle_incoming|Known peers|Packet sent"
   ```

### –û—á—ñ–∫—É–≤–∞–Ω—ñ –ª–æ–≥–∏ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ:
```
üì§ create_and_send_packet_to: recipient=<id>
üì§ Known peers count: X
üì§ Found peer: <id> at <transport>
üì§ Peer has x25519 key, length=32
‚úÖ Created encrypted packet, sending...
‚úÖ Packet sent successfully
```

### –û—á—ñ–∫—É–≤–∞–Ω—ñ –ª–æ–≥–∏ –ø—Ä–∏ –ø—Ä–∏–π–æ–º—ñ:
```
üì• handle_incoming_packet_internal: bytes=X, peer_info=Some(...)
üì• Packet deserialized: sender=<id>
üì• Updating peer: <id> at <address> via <transport>
‚úÖ Peer updated in router
‚úÖ Message decrypted successfully
üì• Router result: true
üì• Processing decrypted message
```

### –ú–æ–∂–ª–∏–≤—ñ –ø—Ä–æ–±–ª–µ–º–∏:
- **"‚ùå Peer not found in known_peers"** - –∫–æ–Ω—Ç–∞–∫—Ç –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–æ–≤–∞–Ω–∏–π –∑ Rust core
  - –í–∏—Ä—ñ—à–µ–Ω–Ω—è: –ø–µ—Ä–µ—Å–∫–∞–Ω—É–≤–∞—Ç–∏ QR –∑ x25519 –∫–ª—é—á–µ–º
- **"‚ùå Peer has no x25519 key"** - –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∫–ª—é—á —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è
  - –í–∏—Ä—ñ—à–µ–Ω–Ω—è: –ø–µ—Ä–µ—Å–∫–∞–Ω—É–≤–∞—Ç–∏ QR (–Ω–æ–≤–∏–π —Ñ–æ—Ä–º–∞—Ç –º—ñ—Å—Ç–∏—Ç—å x25519)
- **"‚ö†Ô∏è Message decryption failed"** - –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è —ñ–Ω—à–æ–≥–æ –æ—Ç—Ä–∏–º—É–≤–∞—á–∞ (relay)
  - –¶–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è relay-–ø–∞–∫–µ—Ç—ñ–≤

---

## Issue #5: –î–≤–æ—Å—Ç–æ—Ä–æ–Ω–Ω—î –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤

### –ó–º—ñ–Ω–∏:
- ‚úÖ –ó–º—ñ–Ω–µ–Ω–æ `CoreGateway.sendText()` –Ω–∞ `CoreGateway.sendTextTo()` –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ `contact_add_request`
- ‚úÖ –¢–µ–ø–µ—Ä –∑–∞–ø–∏—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É, —è–∫–æ–≥–æ –¥–æ–¥–∞—î—Ç–µ, –∞ –Ω–µ –≤—Å—ñ–º
- ‚úÖ –û–±—Ä–æ–±–Ω–∏–∫ `handleContactAddRequest()` –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–æ–¥–∞—î –≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫–∞ –≤ –∫–æ–Ω—Ç–∞–∫—Ç–∏

### –Ø–∫ —Ç–µ—Å—Ç—É–≤–∞—Ç–∏:
1. **–ü—Ä–∏—Å—Ç—Ä—ñ–π A –≥–µ–Ω–µ—Ä—É—î QR:**
   - Family ‚Üí —ñ–∫–æ–Ω–∫–∞ QR
   - QR –º—ñ—Å—Ç–∏—Ç—å: ID, —ñ–º'—è, x25519 –ø—É–±–ª—ñ—á–Ω–∏–π –∫–ª—é—á

2. **–ü—Ä–∏—Å—Ç—Ä—ñ–π B —Å–∫–∞–Ω—É—î QR:**
   - Family ‚Üí —ñ–∫–æ–Ω–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞
   - –Ü–º'—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ–¥—Ç—è–≥—É—î—Ç—å—Å—è –∑ QR
   - –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ "–î–æ–¥–∞—Ç–∏"

3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è:**
   - –ü—Ä–∏—Å—Ç—Ä—ñ–π B –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î `contact_add_request` —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏—Å—Ç—Ä–æ—é A
   - –ü—Ä–∏—Å—Ç—Ä—ñ–π A –æ—Ç—Ä–∏–º—É—î –∑–∞–ø–∏—Ç —á–µ—Ä–µ–∑ `TransportService.handleIncoming()`
   - `handleContactAddRequest()` –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –¥–æ–¥–∞—î –ø—Ä–∏—Å—Ç—Ä—ñ–π B

4. **–ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - –ù–∞ –ø—Ä–∏—Å—Ç—Ä–æ—ó A: Family ‚Üí –º–∞—î –∑'—è–≤–∏—Ç–∏—Å—å –∫–æ–Ω—Ç–∞–∫—Ç –∑ –ø—Ä–∏—Å—Ç—Ä–æ—é B
   - –ù–∞ –ø—Ä–∏—Å—Ç—Ä–æ—ó B: Family ‚Üí –∫–æ–Ω—Ç–∞–∫—Ç A –≤–∂–µ –¥–æ–¥–∞–Ω–∏–π –≤—Ä—É—á–Ω—É

### –û—á—ñ–∫—É–≤–∞–Ω—ñ –ª–æ–≥–∏:
**–ù–∞ –ø—Ä–∏—Å—Ç—Ä–æ—ó B (—è–∫–∏–π —Å–∫–∞–Ω—É–≤–∞–≤):**
```
üîµ Sending contact_add_request: id=<B_id>, name=<B_name>, to=<A_id>
üîµ SendTextTo result: 0 (to <A_id>)
```

**–ù–∞ –ø—Ä–∏—Å—Ç—Ä–æ—ó A (–≤–ª–∞—Å–Ω–∏–∫ QR):**
```
üîµ Message content: {"type":"contact_add_request","id":"<B_id>","name":"<B_name>","x25519":"..."}
üîµ Found contact_add_request, processing...
üîµ handleContactAddRequest: {"type":"contact_add_request",...}
üîµ Parsed: id=<B_id>, name=<B_name>, x25519=true
‚úÖ Adding new contact: <B_name>
```

### –ú–æ–∂–ª–∏–≤—ñ –ø—Ä–æ–±–ª–µ–º–∏:
- **"‚ö†Ô∏è Contact already exists"** - –∫–æ–Ω—Ç–∞–∫—Ç –≤–∂–µ –¥–æ–¥–∞–Ω–∏–π
  - –¶–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –ø–æ–≤—Ç–æ—Ä–Ω–µ –¥–æ–¥–∞–≤–∞–Ω–Ω—è —ñ–≥–Ω–æ—Ä—É—î—Ç—å—Å—è
- **"‚ùå Empty contactId"** - –Ω–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –∑–∞–ø–∏—Ç—É
  - –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —â–æ QR –º—ñ—Å—Ç–∏—Ç—å –≤–∞–ª—ñ–¥–Ω–∏–π ID
- **"‚ùå Not a contact_add_request"** - –Ω–µ–≤—ñ—Ä–Ω–∏–π —Ç–∏–ø –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
  - –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ñ–æ—Ä–º–∞—Ç JSON

---

## –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤—Å—ñ—Ö –≤–∏–¥—ñ–≤ –∑–≤'—è–∑–∫—É (Issue #4)

### Bluetooth:
1. –£–≤—ñ–º–∫–Ω—É—Ç–∏ Bluetooth –Ω–∞ –æ–±–æ—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö
2. –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
3. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ª–æ–≥–∏: `transport_type = Ble`

### WiFi Direct:
1. –£–≤—ñ–º–∫–Ω—É—Ç–∏ WiFi –Ω–∞ –æ–±–æ—Ö –ø—Ä–∏—Å—Ç—Ä–æ—è—Ö
2. –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—å –¥–æ –æ–¥–Ω—ñ—î—ó –º–µ—Ä–µ–∂—ñ –∞–±–æ –∞–∫—Ç–∏–≤—É–≤–∞—Ç–∏ WiFi Direct
3. –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
4. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ª–æ–≥–∏: `transport_type = WifiDirect`

### Internet (Relay):
1. –û–±–∏–¥–≤–∞ –ø—Ä–∏—Å—Ç—Ä–æ—ó –ø—ñ–¥–∫–ª—é—á–µ–Ω—ñ –¥–æ Internet
2. Relay server –ø—Ä–∞—Ü—é—î (–ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö)
3. –ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
4. –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ –ª–æ–≥–∏: `transport_type = Internet`

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å—É –∑'—î–¥–Ω–∞–Ω—å:
Main –µ–∫—Ä–∞–Ω ‚Üí footer –ø–æ–∫–∞–∑—É—î:
- üì∂ Bluetooth —É–≤—ñ–º–∫–Ω–µ–Ω–æ / üìµ –≤–∏–º–∫–Ω–µ–Ω–æ
- üîó Mesh –º–µ—Ä–µ–∂–∞ (WiFi) –∞–∫—Ç–∏–≤–Ω–∞ / ‚õìÔ∏è‚Äçüí• –≤–∏–º–∫–Ω–µ–Ω–∞
- üåê Internet –¥–æ—Å—Ç—É–ø–Ω–∏–π / üö´ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π

---

## –ö–æ–º–∞–Ω–¥–∏ –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### –û—á–∏—Å—Ç–∏—Ç–∏ –ª–æ–≥–∏ —Ç–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–∏ –¥–æ–¥–∞—Ç–æ–∫:
```powershell
adb logcat -c
adb shell am start -n app.poruch.ya_ok/.MainActivity
```

### –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å:
```powershell
adb logcat | Select-String "create_and_send|SendTextTo|Packet sent"
```

### –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–∏–π–æ–º—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å:
```powershell
adb logcat | Select-String "handle_incoming|Packet deserialized|Message decrypted"
```

### –ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤:
```powershell
adb logcat | Select-String "contact_add_request|handleContactAddRequest|Adding new contact"
```

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ known_peers:
```powershell
adb logcat | Select-String "Known peers count|Found peer"
```

---

## –°—Ç–∞—Ç—É—Å —Ä–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó

### ‚úÖ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ:
1. Issue #1: QR scanner username (URL decode)
2. Issue #2: Contact selection for messaging (dialog + FFI)
3. Issue #3: Inbox/outbox tabs (TabLayout)
4. Issue #4: Message delivery logging (diagnostic tools)
5. Issue #5: Bidirectional contact addition (sendTextTo)
6. Issue #6: Connection status indicators (Bluetooth + Internet)

### üîç –ü–æ—Ç—Ä–µ–±—É—î —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è:
- –î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å —á–µ—Ä–µ–∑ —Ä—ñ–∑–Ω—ñ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤ –ø—Ä–∏ —Å–∫–∞–Ω—É–≤–∞–Ω–Ω—ñ QR
- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è x25519

### üìã –ü—Ä–∏–º—ñ—Ç–∫–∏:
- –í—Å—ñ –∑–º—ñ–Ω–∏ –≤ Rust core –º–∞—é—Ç—å –¥–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è
- Kotlin –∫–æ–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `sendTextTo()` –¥–ª—è —Ü—ñ–ª—å–æ–≤–æ—ó –¥–æ—Å—Ç–∞–≤–∫–∏
- `handleContactAddRequest()` –≤ `TransportService` –æ–±—Ä–æ–±–ª—è—î –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –¥–æ–¥–∞–≤–∞–Ω–Ω—è
