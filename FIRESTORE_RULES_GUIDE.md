# üîí Firestore Security Rules - –ì–∞–π–¥

## üìã –û–≥–ª—è–¥ –ø—Ä–∞–≤–∏–ª

–ü—Ä–∞–≤–∏–ª–∞ –±–µ–∑–ø–µ–∫–∏ –¥–ª—è Firestore –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ –¥–ª—è –ø—Ä–æ–µ–∫—Ç—É "–Ø –û–ö" –∑ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–º –∑–∞—Ö–∏—Å—Ç–æ–º –¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.

---

## üõ°Ô∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∞–≤–∏–ª

### **1. Users Collection (`/users/{userId}`)**

#### ‚úÖ **Create (–°—Ç–≤–æ—Ä–µ–Ω–Ω—è)**
- –¢—ñ–ª—å–∫–∏ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —Å–≤—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å
- `userId` –º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ `request.auth.uid`
- –û–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è: `name`, `email`, `createdAt`, `contactIds`

#### ‚úÖ **Read (–ß–∏—Ç–∞–Ω–Ω—è)**
- –í–ª–∞—Å–Ω–∏–∫ –º–æ–∂–µ —á–∏—Ç–∞—Ç–∏ —Å–≤—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å –ø–æ–≤–Ω—ñ—Å—Ç—é
- –ö–æ–Ω—Ç–∞–∫—Ç–∏ –º–æ–∂—É—Ç—å —á–∏—Ç–∞—Ç–∏ –±–∞–∑–æ–≤—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é (—ñ–º'—è, –∞–≤–∞—Ç–∞—Ä)
- –¢—ñ–ª—å–∫–∏ —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —î –≤ —Å–ø–∏—Å–∫—É –∫–æ–Ω—Ç–∞–∫—Ç—ñ–≤

#### ‚úÖ **Update (–û–Ω–æ–≤–ª–µ–Ω–Ω—è)**
- –¢—ñ–ª—å–∫–∏ –≤–ª–∞—Å–Ω–∏–∫ –º–æ–∂–µ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ —Å–≤—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å
- –ó–∞–±–æ—Ä–æ–Ω–µ–Ω–æ –∑–º—ñ–Ω—é–≤–∞—Ç–∏: `id`, `email`, `createdAt`
- –î–æ–∑–≤–æ–ª–µ–Ω–æ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏: `name`, `phone`, `contactIds`, `pushToken`

#### ‚úÖ **Delete (–í–∏–¥–∞–ª–µ–Ω–Ω—è)**
- –¢—ñ–ª—å–∫–∏ –≤–ª–∞—Å–Ω–∏–∫ –º–æ–∂–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Å–≤—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å

---

### **2. Checkins Collection (`/checkins/{checkinId}`)**

#### ‚úÖ **Create (–°—Ç–≤–æ—Ä–µ–Ω–Ω—è)**
- –¢—ñ–ª—å–∫–∏ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ —á–µ–∫—ñ–Ω
- `userId` –º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ `request.auth.uid`
- –û–±–æ–≤'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è: `userId`, `status`, `timestamp`, `recipientIds`
- –°—Ç–∞—Ç—É—Å –º–∞—î –±—É—Ç–∏ –æ–¥–Ω–∏–º –∑: `'ok'`, `'busy'`, `'later'`, `'hug'`

#### ‚úÖ **Read (–ß–∏—Ç–∞–Ω–Ω—è)**
- –í–ª–∞—Å–Ω–∏–∫ –º–æ–∂–µ —á–∏—Ç–∞—Ç–∏ —Å–≤–æ—ó —á–µ–∫—ñ–Ω–∏
- –û—Ç—Ä–∏–º—É–≤–∞—á—ñ –º–æ–∂—É—Ç—å —á–∏—Ç–∞—Ç–∏ —á–µ–∫—ñ–Ω–∏, –∞–¥—Ä–µ—Å–æ–≤–∞–Ω—ñ —ó–º
- –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–µ—Ä–µ–∑ `recipientIds` array

#### ‚úÖ **Update (–û–Ω–æ–≤–ª–µ–Ω–Ω—è)**
- **–í–ª–∞—Å–Ω–∏–∫** –º–æ–∂–µ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ø–æ–ª–µ `synced`
- **–û—Ç—Ä–∏–º—É–≤–∞—á—ñ** –º–æ–∂—É—Ç—å –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ø–æ–ª–µ `readBy`
- –í—Å—ñ —ñ–Ω—à—ñ –ø–æ–ª—è –∑–∞—Ö–∏—â–µ–Ω—ñ –≤—ñ–¥ –∑–º—ñ–Ω

#### ‚úÖ **Delete (–í–∏–¥–∞–ª–µ–Ω–Ω—è)**
- –¢—ñ–ª—å–∫–∏ –≤–ª–∞—Å–Ω–∏–∫ –º–æ–∂–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Å–≤—ñ–π —á–µ–∫—ñ–Ω

---

## üîê –ë–µ–∑–ø–µ–∫–∞

### **–ü—Ä–∏–Ω—Ü–∏–ø–∏:**
1. ‚úÖ **–ê–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –æ–±–æ–≤'—è–∑–∫–æ–≤–∞** –¥–ª—è –≤—Å—ñ—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π
2. ‚úÖ **–í–ª–∞—Å–Ω—ñ—Å—Ç—å –¥–∞–Ω–∏—Ö** - –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –∫–µ—Ä—É–≤–∞—Ç–∏ —Ç—ñ–ª—å–∫–∏ —Å–≤–æ—ó–º–∏ –¥–∞–Ω–∏–º–∏
3. ‚úÖ **–ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –¥–æ—Å—Ç—É–ø** - –∫–æ–Ω—Ç–∞–∫—Ç–∏ –±–∞—á–∞—Ç—å —Ç—ñ–ª—å–∫–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é
4. ‚úÖ **–í–∞–ª—ñ–¥–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö** - –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —Ç–∏–ø—ñ–≤ —Ç–∞ –æ–±–æ–≤'—è–∑–∫–æ–≤–∏—Ö –ø–æ–ª—ñ–≤
5. ‚úÖ **–ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –∑–º—ñ–Ω** - –∫—Ä–∏—Ç–∏—á–Ω—ñ –ø–æ–ª—è –Ω–µ –º–æ–∂–Ω–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏

---

## üß™ –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–∞–≤–∏–ª

### **–í–∞—Ä—ñ–∞–Ω—Ç 1: Firebase Console**
1. –ü–µ—Ä–µ–π—Ç–∏ –≤ Firebase Console ‚Üí Firestore Database ‚Üí Rules
2. –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ "Rules Playground"
3. –¢–µ—Å—Ç—É–≤–∞—Ç–∏ —Ä—ñ–∑–Ω—ñ —Å—Ü–µ–Ω–∞—Ä—ñ—ó

### **–í–∞—Ä—ñ–∞–Ω—Ç 2: Firebase Emulator**
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç–∏ emulator
firebase emulators:start --only firestore

# –¢–µ—Å—Ç—É–≤–∞—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞
firebase emulators:exec --only firestore "flutter test"
```

---

## üìù –ü—Ä–∏–∫–ª–∞–¥–∏ —Ç–µ—Å—Ç—ñ–≤

### ‚úÖ **–£—Å–ø—ñ—à–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó:**

```javascript
// 1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Å—Ç–≤–æ—Ä—é—î —Å–≤—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å
create(/databases/(default)/documents/users/user123) {
  auth.uid == "user123"
  data: { name: "–Ü–≤–∞–Ω", email: "ivan@example.com", ... }
} // ‚úÖ ALLOWED

// 2. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —á–∏—Ç–∞—î —Å–≤—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å
get(/databases/(default)/documents/users/user123) {
  auth.uid == "user123"
} // ‚úÖ ALLOWED

// 3. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á —Å—Ç–≤–æ—Ä—é—î —á–µ–∫—ñ–Ω
create(/databases/(default)/documents/checkins/checkin1) {
  auth.uid == "user123"
  data: { userId: "user123", status: "ok", recipientIds: ["user456"] }
} // ‚úÖ ALLOWED

// 4. –û—Ç—Ä–∏–º—É–≤–∞—á —á–∏—Ç–∞—î —á–µ–∫—ñ–Ω
get(/databases/(default)/documents/checkins/checkin1) {
  auth.uid == "user456"
  resource.data.recipientIds == ["user456"]
} // ‚úÖ ALLOWED

// 5. –û—Ç—Ä–∏–º—É–≤–∞—á –ø–æ–∑–Ω–∞—á–∞—î —è–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–∏–π
update(/databases/(default)/documents/checkins/checkin1) {
  auth.uid == "user456"
  onlyChanged: ["readBy"]
} // ‚úÖ ALLOWED
```

### ‚ùå **–ó–∞–±–æ—Ä–æ–Ω–µ–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó:**

```javascript
// 1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å —ñ–Ω—à–æ–≥–æ
create(/databases/(default)/documents/users/user456) {
  auth.uid == "user123"
} // ‚ùå DENIED

// 2. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –ø—Ä–æ—á–∏—Ç–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å –Ω–µ-–∫–æ–Ω—Ç–∞–∫—Ç—É
get(/databases/(default)/documents/users/user789) {
  auth.uid == "user123"
  resource.data.contactIds != ["user123"]
} // ‚ùå DENIED

// 3. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –∑–º—ñ–Ω–∏—Ç–∏ email
update(/databases/(default)/documents/users/user123) {
  auth.uid == "user123"
  changed: ["email"]
} // ‚ùå DENIED

// 4. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –∑–º—ñ–Ω–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å —á–µ–∫—ñ–Ω—É
update(/databases/(default)/documents/checkins/checkin1) {
  auth.uid == "user456"
  changed: ["status"]
} // ‚ùå DENIED
```

---

## üöÄ –†–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è –ø—Ä–∞–≤–∏–ª

### **–í–∞—Ä—ñ–∞–Ω—Ç 1: Firebase Console**
1. –í—ñ–¥–∫—Ä–∏—Ç–∏ Firebase Console ‚Üí Firestore Database ‚Üí Rules
2. –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞ –∑ `firestore.rules`
3. –ù–∞—Ç–∏—Å–Ω—É—Ç–∏ "Publish"

### **–í–∞—Ä—ñ–∞–Ω—Ç 2: Firebase CLI**
```bash
# –†–æ–∑–≥–æ—Ä–Ω—É—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞
firebase deploy --only firestore:rules

# –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å
firebase deploy --only firestore:rules --dry-run
```

---

## ‚ö†Ô∏è –í–∞–∂–ª–∏–≤—ñ –∑–∞—É–≤–∞–∂–µ–Ω–Ω—è

1. **–Ü–Ω–¥–µ–∫—Å–∏:** –ü—Ä–∞–≤–∏–ª–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å `arrayContains` –¥–ª—è `recipientIds` - –ø–æ—Ç—Ä—ñ–±–µ–Ω —ñ–Ω–¥–µ–∫—Å (–≤–∂–µ –≤ `firestore.indexes.json`)

2. **Performance:** –ü—Ä–∞–≤–∏–ª–∞ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –Ω–∞ –∫–æ–∂–µ–Ω –∑–∞–ø–∏—Ç - —É–Ω–∏–∫–∞–π—Ç–µ —Å–∫–ª–∞–¥–Ω–∏—Ö –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫

3. **–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è:** –ó–∞–≤–∂–¥–∏ —Ç–µ—Å—Ç—É–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–µ—Ä–µ–¥ production

4. **–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥:** –°—Ç–µ–∂—Ç–µ –∑–∞ –ø–æ–º–∏–ª–∫–∞–º–∏ –≤ Firebase Console ‚Üí Firestore ‚Üí Usage

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è

- [Firestore Security Rules](https://firebase.google.com/docs/firestore/security/get-started)
- [Rules Language](https://firebase.google.com/docs/firestore/security/rules-language)
- [Testing Rules](https://firebase.google.com/docs/firestore/security/test-rules-emulator)

---

**–ó—Ä–æ–±–ª–µ–Ω–æ –≤ –£–∫—Ä–∞—ó–Ω—ñ üá∫üá¶**
